<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚... - Ø³Ø­Ø§Ø¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 450px;
            width: 100%;
            padding: 60px 40px;
            text-align: center;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        h1 {
            color: #667eea;
            font-size: 28px;
            margin-bottom: 16px;
        }

        p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(102, 126, 234, 0.2);
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-icon">ğŸš—</div>
        <h1>Ø³Ø­Ø§Ø¨</h1>
        <p id="status">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·...</p>
        <div class="loader" id="loader"></div>
        <div class="error" id="error"></div>
        <div class="success" id="success"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://ryoshojfihwilzgfxvkg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ5b3Nob2pmaWh3aWx6Z2Z4dmtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgyMDQ4OTksImV4cCI6MjA3Mzc4MDg5OX0.uDehGlr9o9IaCPHbMi4HdYeA7K0-K3gu2omWuecFLb8';
        
        const { createClient } = window.supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const statusEl = document.getElementById('status');
        const loaderEl = document.getElementById('loader');
        const errorEl = document.getElementById('error');
        const successEl = document.getElementById('success');

        console.log('ğŸ” ØµÙØ­Ø© Ø§Ù„ØªØ­Ù‚Ù‚ - Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
        console.log('ğŸŒ URL:', window.location.href);

        async function handleAuth() {
            try {
                // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ù† Ø§Ù„Ù€ URL
                const urlParams = new URLSearchParams(window.location.search);
                const token_hash = urlParams.get('token_hash');
                const type = urlParams.get('type');
                const next = urlParams.get('next') || '/';

                console.log('ğŸ“‹ Token Hash:', token_hash ? 'Ù…ÙˆØ¬ÙˆØ¯' : 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
                console.log('ğŸ“‹ Type:', type);
                console.log('ğŸ“‹ Next:', next);

                if (!token_hash || !type) {
                    throw new Error('Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }

                statusEl.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø²...';

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù€ OTP
                const { data, error } = await supabaseClient.auth.verifyOtp({
                    token_hash: token_hash,
                    type: type
                });

                console.log('âœ… Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªØ­Ù‚Ù‚:', { data, error });

                if (error) {
                    throw error;
                }

                // Ù†Ø¬Ø­ Ø§Ù„ØªØ­Ù‚Ù‚
                loaderEl.style.display = 'none';
                successEl.style.display = 'block';
                statusEl.textContent = '';

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†ÙˆØ¹ recoveryØŒ Ù†ÙˆØ¬Ù‡ Ù„ØµÙØ­Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                if (type === 'recovery') {
                    successEl.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±...';
                    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰ ØµÙØ­Ø© reset-password');
                    
                    setTimeout(() => {
                        window.location.href = 'https://hammam1233.github.io/sahab-auth-pages/reset-password.html';
                    }, 1500);
                } else {
                    // Ø£ÙŠ Ù†ÙˆØ¹ Ø¢Ø®Ø± (Ù…Ø«Ù„ email confirmation)
                    successEl.textContent = 'âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡...';
                    console.log('ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø¥Ù„Ù‰:', next);
                    
                    setTimeout(() => {
                        window.location.href = next;
                    }, 1500);
                }

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                
                loaderEl.style.display = 'none';
                errorEl.style.display = 'block';
                statusEl.textContent = '';
                
                let errorMessage = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·';
                
                if (error.message) {
                    if (error.message.includes('expired')) {
                        errorMessage = 'Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚';
                    } else if (error.message.includes('invalid')) {
                        errorMessage = 'Ø§Ù„Ø±Ø§Ø¨Ø· ØºÙŠØ± ØµØ§Ù„Ø­. ÙŠØ±Ø¬Ù‰ Ø·Ù„Ø¨ Ø±Ø§Ø¨Ø· Ø¬Ø¯ÙŠØ¯';
                    } else {
                        errorMessage = error.message;
                    }
                }
                
                errorEl.innerHTML = `
                    <strong>âŒ ${errorMessage}</strong><br><br>
                    <small>ÙŠÙ…ÙƒÙ†Ùƒ Ø¥ØºÙ„Ø§Ù‚ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ·Ø¨ÙŠÙ‚</small>
                `;
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        handleAuth();
    </script>
</body>
</html>
